<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Links | BeakyBabe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="links.css">
</head>

<body>
    <div class="bg-gradient"></div>
    <div class="bg-grid"></div>

    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <p>Loading your links...</p>
    </div>

    <div class="dashboard-layout" id="dashboardLayout" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <span class="logo-icon">ğŸ¦</span>
                    <span class="logo-text">BeakyBabe</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item" data-section="overview">
                    <span class="nav-icon">ğŸ“Š</span><span>Overview</span>
                </a>
                <a href="links.html" class="nav-item active" data-section="links">
                    <span class="nav-icon">ğŸ”—</span><span>My Links</span>
                </a>
                <a href="appearance.html" class="nav-item" data-section="appearance">
                    <span class="nav-icon">ğŸ¨</span><span>Appearance</span>
                </a>
                <a href="analytics.html" class="nav-item" data-section="analytics">
                    <span class="nav-icon">ğŸ“ˆ</span><span>Analytics</span>
                </a>
                <a href="store.html" class="nav-item" data-section="store">
                    <span class="nav-icon">ğŸ›’</span><span>Store</span>
                </a>
                <a href="settings.html" class="nav-item" data-section="settings">
                    <span class="nav-icon">âš™ï¸</span><span>Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="plan-badge"><span class="badge-icon">â­</span><span>Free Plan</span></div>
                <a href="#" class="upgrade-btn">Upgrade to Pro</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn"><span></span><span></span><span></span></button>
                    <div class="page-title">
                        <h1>My Links</h1>
                        <p>Add and manage your links</p>
                    </div>
                </div>
                <div class="topbar-right">
                    <a href="#" class="preview-btn" id="previewBtn" target="_blank">
                        <span class="btn-icon">ğŸ‘ï¸</span><span>Preview Page</span>
                    </a>
                    <div class="user-menu" id="userMenu">
                        <div class="user-avatar" id="userAvatar"><span>?</span></div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-header">
                                <span class="user-name" id="userName">Loading...</span>
                                <span class="user-email" id="userEmail">...</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="settings.html" class="dropdown-item"><span>âš™ï¸</span> Settings</a>
                            <a href="#" class="dropdown-item" id="logoutBtn"><span>ğŸšª</span> Sign Out</a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">
                <!-- Add Link Form -->
                <div class="add-link-card">
                    <form id="addLinkForm" class="add-link-form">
                        <div class="form-row">
                            <div class="icon-picker" id="iconPicker">
                                <button type="button" class="icon-btn" id="selectedIcon">ğŸ”—</button>
                                <div class="icon-dropdown" id="iconDropdown">
                                    <div class="icon-grid">
                                        <button type="button" data-icon="ğŸ”—">ğŸ”—</button>
                                        <button type="button" data-icon="ğŸŒ">ğŸŒ</button>
                                        <button type="button" data-icon="ğŸ“º">ğŸ“º</button>
                                        <button type="button" data-icon="ğŸ“±">ğŸ“±</button>
                                        <button type="button" data-icon="ğŸµ">ğŸµ</button>
                                        <button type="button" data-icon="ğŸ®">ğŸ®</button>
                                        <button type="button" data-icon="ğŸ“¸">ğŸ“¸</button>
                                        <button type="button" data-icon="ğŸ¦">ğŸ¦</button>
                                        <button type="button" data-icon="ğŸ’¼">ğŸ’¼</button>
                                        <button type="button" data-icon="ğŸ“§">ğŸ“§</button>
                                        <button type="button" data-icon="ğŸ›’">ğŸ›’</button>
                                        <button type="button" data-icon="ğŸ“š">ğŸ“š</button>
                                        <button type="button" data-icon="ğŸ¨">ğŸ¨</button>
                                        <button type="button" data-icon="ğŸ’°">ğŸ’°</button>
                                        <button type="button" data-icon="ğŸ¯">ğŸ¯</button>
                                        <button type="button" data-icon="â­">â­</button>
                                    </div>
                                </div>
                            </div>
                            <input type="text" id="linkTitle" class="form-input" placeholder="Link title" required>
                            <input type="url" id="linkUrl" class="form-input" placeholder="https://..." required>
                            <button type="submit" class="btn btn-primary">
                                <span>â•</span> Add Link
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Links List -->
                <div class="links-container">
                    <div class="links-header">
                        <h3>Your Links <span class="link-count" id="linkCount">(0)</span></h3>
                        <p class="drag-hint">ğŸ’¡ Drag to reorder</p>
                    </div>

                    <div class="links-list" id="linksList">
                        <!-- Links will be loaded here -->
                    </div>

                    <div class="empty-state" id="emptyState" style="display: none;">
                        <div class="empty-icon">ğŸ”—</div>
                        <h3>No links yet</h3>
                        <p>Add your first link above to get started!</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Link Modal -->
    <div class="modal-overlay" id="editModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Link</h3>
                <button class="modal-close" id="closeModal">âœ•</button>
            </div>
            <form id="editLinkForm" class="modal-body">
                <input type="hidden" id="editLinkId">

                <div class="form-group">
                    <label>Icon</label>
                    <div class="icon-picker-large">
                        <div class="icon-grid" id="editIconGrid">
                            <button type="button" data-icon="ğŸ”—">ğŸ”—</button>
                            <button type="button" data-icon="ğŸŒ">ğŸŒ</button>
                            <button type="button" data-icon="ğŸ“º">ğŸ“º</button>
                            <button type="button" data-icon="ğŸ“±">ğŸ“±</button>
                            <button type="button" data-icon="ğŸµ">ğŸµ</button>
                            <button type="button" data-icon="ğŸ®">ğŸ®</button>
                            <button type="button" data-icon="ğŸ“¸">ğŸ“¸</button>
                            <button type="button" data-icon="ğŸ¦">ğŸ¦</button>
                            <button type="button" data-icon="ğŸ’¼">ğŸ’¼</button>
                            <button type="button" data-icon="ğŸ“§">ğŸ“§</button>
                            <button type="button" data-icon="ğŸ›’">ğŸ›’</button>
                            <button type="button" data-icon="ğŸ“š">ğŸ“š</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editTitle">Title</label>
                    <input type="text" id="editTitle" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="editUrl">URL</label>
                    <input type="url" id="editUrl" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="editActive" checked>
                        <span>Link is active</span>
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" id="cancelEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="config.js"></script>
    <script src="db.js"></script>
    <script>
        let currentLinks = [];
        let selectedIcon = 'ğŸ”—';
        let editIcon = 'ğŸ”—';

        document.addEventListener('DOMContentLoaded', async () => {
            const session = await Auth.requireAuth();
            if (!session) return;

            const user = await Auth.getUser();
            const userName = user.user_metadata?.full_name || user.email.split('@')[0];
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').innerHTML = `<span>${userName.charAt(0).toUpperCase()}</span>`;

            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('dashboardLayout').style.display = 'flex';

            // Load links
            await loadLinks();

            // Initialize Sortable
            initSortable();

            // Event Listeners
            setupEventListeners();
        });

        async function loadLinks() {
            const { data: links, error } = await DB.getLinks();

            if (error) {
                console.error('Error loading links:', error);
                return;
            }

            currentLinks = links;
            renderLinks();
        }

        function renderLinks() {
            const container = document.getElementById('linksList');
            const emptyState = document.getElementById('emptyState');
            const linkCount = document.getElementById('linkCount');

            linkCount.textContent = `(${currentLinks.length})`;

            if (currentLinks.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            container.innerHTML = currentLinks.map(link => `
                <div class="link-item-card" data-id="${link.id}">
                    <div class="drag-handle">â‹®â‹®</div>
                    <div class="link-icon">${link.icon || 'ğŸ”—'}</div>
                    <div class="link-details">
                        <span class="link-title">${escapeHtml(link.title)}</span>
                        <span class="link-url">${escapeHtml(link.url)}</span>
                    </div>
                    <div class="link-stats">
                        <span class="click-count">${link.total_clicks || 0} clicks</span>
                    </div>
                    <div class="link-actions">
                        <label class="toggle-switch small">
                            <input type="checkbox" ${link.is_active ? 'checked' : ''} onchange="toggleLink('${link.id}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <button class="icon-btn-sm" onclick="editLink('${link.id}')" title="Edit">âœï¸</button>
                        <button class="icon-btn-sm delete" onclick="deleteLink('${link.id}')" title="Delete">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function initSortable() {
            const container = document.getElementById('linksList');
            new Sortable(container, {
                animation: 200,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: async function (evt) {
                    const items = container.querySelectorAll('.link-item-card');
                    const newOrder = Array.from(items).map(item => item.dataset.id);
                    await DB.reorderLinks(newOrder);
                    await loadLinks();
                }
            });
        }

        function setupEventListeners() {
            // Add Link Form
            document.getElementById('addLinkForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const title = document.getElementById('linkTitle').value;
                const url = document.getElementById('linkUrl').value;

                const { data, error } = await DB.createLink({
                    title,
                    url,
                    icon: selectedIcon
                });

                if (error) {
                    alert('Error adding link: ' + error.message);
                    return;
                }

                document.getElementById('linkTitle').value = '';
                document.getElementById('linkUrl').value = '';
                selectedIcon = 'ğŸ”—';
                document.getElementById('selectedIcon').textContent = 'ğŸ”—';

                await loadLinks();
            });

            // Icon Picker
            const iconPicker = document.getElementById('iconPicker');
            const iconDropdown = document.getElementById('iconDropdown');
            const selectedIconBtn = document.getElementById('selectedIcon');

            selectedIconBtn.addEventListener('click', (e) => {
                e.preventDefault();
                iconDropdown.classList.toggle('show');
            });

            iconDropdown.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedIcon = btn.dataset.icon;
                    selectedIconBtn.textContent = selectedIcon;
                    iconDropdown.classList.remove('show');
                });
            });

            // Edit Modal
            document.getElementById('editLinkForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const id = document.getElementById('editLinkId').value;
                const title = document.getElementById('editTitle').value;
                const url = document.getElementById('editUrl').value;
                const isActive = document.getElementById('editActive').checked;

                const { error } = await DB.updateLink(id, {
                    title,
                    url,
                    icon: editIcon,
                    is_active: isActive
                });

                if (error) {
                    alert('Error updating link: ' + error.message);
                    return;
                }

                closeEditModal();
                await loadLinks();
            });

            document.getElementById('closeModal').addEventListener('click', closeEditModal);
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            document.getElementById('editModal').addEventListener('click', (e) => {
                if (e.target.id === 'editModal') closeEditModal();
            });

            // Edit Icon Grid
            document.getElementById('editIconGrid').querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#editIconGrid button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    editIcon = btn.dataset.icon;
                });
            });

            // User Menu
            document.getElementById('userMenu').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('userDropdown').classList.toggle('show');
            });

            document.addEventListener('click', () => {
                document.getElementById('userDropdown').classList.remove('show');
                document.getElementById('iconDropdown').classList.remove('show');
            });

            document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                await Auth.signOut();
            });

            // Mobile Menu
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('mobile-open');
            });
        }

        function editLink(id) {
            const link = currentLinks.find(l => l.id === id);
            if (!link) return;

            document.getElementById('editLinkId').value = link.id;
            document.getElementById('editTitle').value = link.title;
            document.getElementById('editUrl').value = link.url;
            document.getElementById('editActive').checked = link.is_active;

            editIcon = link.icon || 'ğŸ”—';
            document.querySelectorAll('#editIconGrid button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.icon === editIcon);
            });

            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function toggleLink(id, isActive) {
            await DB.updateLink(id, { is_active: isActive });
        }

        async function deleteLink(id) {
            if (!confirm('Are you sure you want to delete this link?')) return;

            const { error } = await DB.deleteLink(id);
            if (error) {
                alert('Error deleting link: ' + error.message);
                return;
            }

            await loadLinks();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>